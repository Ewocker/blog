---
layout: post
title: Kubernetes Workload Basics
description: æœ¬ç¯‡æ–‡ç« å°‡æœƒä»‹ç´¹ k8s ä¸­ PodSpec æœ€å¸¸è¦‹çš„å¹¾å€‹èˆ‡ container æœ¬èº«æœ‰é—œçš„è¨­å®šï¼Œç‰¹åˆ¥æ˜¯ Resources ä»¥åŠ Probesã€‚
series: Kubernetes
image:
  src: /blog/k8s-intro/03/hero.png
  alt: hero
  width: 750
  height: 536
keywords:
  - container
  - k8s
  - tech
  - cloud
head:
  meta:
    - name: author
      content: å°è²“è²“å·¥ç¨‹å¸«
    - name: read
      content: 8 min read
    - property: article:published_time
      content: 2021-03-12T00:00:00.000Z
    - property: article:modified_time
      content: 2023-03-20T00:00:00.000Z
---

æœ¬ç¯‡æ–‡ç« å°‡æœƒä»‹ç´¹ k8s ä¸­ PodSpec æœ€å¸¸è¦‹çš„å¹¾å€‹èˆ‡ container æœ¬èº«æœ‰é—œçš„è¨­å®šï¼Œç‰¹åˆ¥æ˜¯ Resources ä»¥åŠ Probesã€‚ã€‚åœ¨ä¸Šä¸€ç¯‡ä¸­æœ€å¾Œæåˆ° [Pod çš„åŸºæœ¬ä¿¡æ¯](https://blog.ewocker.com/blog/k8s-intro/02/#pod)ï¼Œå¿«é€Ÿåœ°è¤‡ç¿’ä¸€ä¸‹å¹¾å€‹é‡é»ï¼š

- Pod æ˜¯ k8s ä¸­å¯éƒ¨ç½²çš„æœ€å°å–®ä½
- Pod æ˜¯ä¸€æˆ–å¤šå€‹ Container çš„é›†åˆé«”
- Pod ä¸­çš„ Container å…±ç”¨åŒä¸€å€‹ Pod IP
- Pod ä¸­çš„ Container å¯ä»¥ä½¿ç”¨åŒæ¨£çš„ Volume

é€™è£¡æˆ‘å€‘ä¾†ç°¡å–®çš„çœ‹çœ‹ Pod çš„å¸¸ç”¨è¨­å®šï¼š

::note
**_é€™è£¡åªæœƒæåˆ°æœ€å¸¸è¦‹çš„å¹¾å€‹è¨­å®šï¼Œä¸¦ä»¥ `k8s@1.17` ç‚ºä¸»ï¼Œå¯ä»¥åƒè€ƒ [Pod API Reference](https://v1-17.docs.kubernetes.io/docs/reference/generated/kubernetes-api/v1.17/?ref=blog.ewocker.com#pod-v1-core) ä¾†çœ‹è¨­å®šç´°é …ã€‚_**
::

```vue [layouts/default.vue]
<template>
  <div>
    Some default layout shared across all pages
    <slot />
  </div>
</template>
```

```yaml
apiVersion: v1
kind: Pod
metadata:
  labels:
    app: echoserver
  name: echoserver
spec:
  initContainers:
    - name: init
      image: busybox:1.28
      command:
        - "sh"
        - "-c"
        - 'echo "preparing application"'
  containers:
    - name: server
      image: ewocker/slim-echoserver:1.0.0
      imagePullPolicy: IfNotPresent
      resources:
        limits:
          cpu: "100m"
          memory: "50Mi"
        requests:
          cpu: "100m"
          memory: "50Mi"
      ports:
        - name: service-port
          containerPort: 8080
      readinessProbe:
        httpGet:
          path: /healthy
          port: service-port
        initialDelaySeconds: 5
        failureThreshold: 2
        periodSeconds: 10
      livenessProbe:
        httpGet:
          path: /ready
          port: service-port
        initialDelaySeconds: 5
        failureThreshold: 2
        periodSeconds: 10
  restartPolicy: Always
  terminationGracePeriodSeconds: 5
```

é¦–å…ˆæ˜¯ `containers` å’Œ `initContainers`ï¼Œä¸€å€‹ Pod å¯ä»¥åŒ…å«å¤šå€‹å®¹å™¨ï¼Œè€Œåœ¨ k8s ä¸­é‚„å°‡å…¶åˆ†ç‚ºå…©ç¨®ï¼Œåˆ†åˆ¥æ˜¯ **ä¸»å®¹å™¨é‹è¡Œå‰å…ˆé‹è¡Œçš„** `**initContainers**` å’Œ åŒ…å«**ä¸»å®¹å™¨çš„ `containers`**ã€‚

- **initContainer** é¡§åæ€ç¾©å°±æ˜¯ç”¨æ–¼ initializationã€‚å¦‚æœæœ‰å¤šå€‹ `initContainers` æ™‚ï¼Œæœƒä¾åºé€å€‹é‹è¡Œã€‚å¸¸è¦‹çš„ `initContainer` æœ‰åƒæ˜¯ç”¨ `nslookup` ç¢ºä¿ DNS reachabilityï¼Œæˆ–æ˜¯é å…ˆå°‡ configuration è™•ç†æˆæ‰€éœ€çš„æ ¼å¼ç­‰ç­‰ã€‚â€Œâ€Œï¼ˆé€™è£¡å› ç‚ºæ¼”ç¤ºéœ€è¦ï¼Œå°±éš¨ä¾¿ echo ä¸€ä¸²å­—ï¼‰
- **container** å‰‡æ˜¯åœ¨æ‰€æœ‰ `initContainer` é‹è¡ŒçµæŸå¾Œæ‰é–‹å§‹çš„ï¼Œå¦‚æœæœ‰å¤šå€‹ `containers` æ™‚ï¼Œæ‰€æœ‰ `containers` æœƒåŒæ™‚é‹è¡Œã€‚

æ¥è‘—ä¾†çœ‹çœ‹ [ContainerSpec](https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.19/#container-v1-core)ï¼Œé€™è£¡ä½¿ç”¨çš„å¹¾å€‹å¸¸è¦‹çš„ field æ˜¯ï¼š

- **name** - å®¹å™¨çš„åå­—ï¼Œä¸»è¦æ˜¯ä½¿é™¤éŒ¯æˆ–æŒ‡æª¢æŸ¥æ—¥èªŒæ™‚æ›´å®¹æ˜“åˆ†åˆ¥ Pod ä¸­çš„å¤šå€‹å®¹å™¨ã€‚
- **image** - æ˜ åƒæª”ï¼Œè©² container æ‰€ä½¿ç”¨çš„æ˜ åƒæª”ã€‚
- **resources** - Â è³‡æºï¼Œè©²å®¹å™¨æ‰€éœ€ä½¿ç”¨çš„ cpu å’Œ memory è³‡æºï¼Œç´°åˆ†ç‚º request å’Œ limitï¼šâ€Œâ€Œ`request` - æ˜¯å®¹å™¨æ‰€è«‹æ±‚çš„è³‡æºï¼Œ[`kube-scheduler`](/blog/k8s-intro/00#kube-scheduler) æœƒåœ¨å‰µå»º Pod æ™‚æœƒæ ¹æ“šæ‰€æœ‰ container request çš„è³‡æºä¾†æ±ºå®šè©² Pod å°‡ç™¼æ´¾åˆ°å“ªä¸€å€‹ Node ä¸Šï¼Œè¢«ç™¼é…åˆ°çš„ Node å¿…é ˆæœ‰è¶³å¤ çš„è³‡æºã€‚â€Œâ€Œ`limit` - æ˜¯é™åˆ¶å®¹å™¨ä¸èƒ½è¶…éçš„è³‡æºç”¨é‡ï¼Œå¦‚æœ cpu è¶…é limit çš„è©± container æœƒè¢« throttle (æ¯ç•¶è¶…éæ™‚æœƒè¢«å£“æŠ‘å›é™åˆ¶çš„ç”¨é‡)ã€‚å¦‚æœ memory è¶…æ¨™çš„è©±å‰‡æ˜¯æœƒè¢« OOMKill (Out of Memory Killï¼Œè©²å®¹å™¨æœƒå› ç‚ºå…§å­˜ä¸è¶³è€Œè¢«åˆªæ‰)ï¼Œé€™ç¨®ç‹€æ³ä¸‹åœ¨ k8s ä¸­ container ç­‰æ–¼æ˜¯è¢«é‡å•Ÿäº†ã€‚â€Œâ€Œresources çš„è¨­å®šéå¸¸é‡è¦ï¼Œå®ƒæœƒè¢«ç”¨æ–¼ç¢ºä¿ Pod è‡³å°‘ä¿æœ‰å±¬æ–¼è‡ªå·± request çš„è³‡æºã€‚Application owner å¿…é ˆè¦äº†è§£æ€éº¼æ¨£çš„è³‡æºé…ç½®å°è‡ªå·±çš„ app æ˜¯æœ€æœ‰æ•ˆç‡çš„ï¼Œä¸¦ä¸”èˆ‡ä»¥å¾Œæœƒæåˆ°çš„**è‡ªé©æ‡‰æ“´ç¸® autoscaling** æœ‰é—œã€‚ï¼ˆä¸‹é¢æœ‰æ›´å¤šä¿¡æ¯ï¼‰
- **ports** - æ˜¯ container çš„ç«¯å£ï¼Œå¦‚æœåŠ ä¸Šäº† name ä¾†å‘½åçš„è©±ï¼Œå‰‡å¯ä»¥åœ¨å…¶ä»–è¨­å®šä¸­ç›´æ¥ç”¨åç¨±ä¾†ä»£æ›¿ç«¯å£ã€‚
- **livenessProbe** - [`kubelet`](/blog/k8s-intro/00#kubelet) æœƒæ ¹æ“š livenessProbe çš„å®šç¾©ä¾†æª¢æŸ¥ container æ˜¯å¦å¥åº·çš„åœ¨é‹è¡Œï¼Œå¦‚æœ livenessProbe ç™¼ç”ŸéŒ¯èª¤å‰‡ container æœƒè¢«æ˜¯æ–¼ **ä¸å¥åº· (Unhealthy)**ï¼Œ[`kubelet`](/blog/k8s-intro/00#kubelet) æœƒé‡å•Ÿè©² containerã€‚â€Œâ€Œä¸Šé¢æ˜¯ä»¥æœ€å¸¸è¦‹çš„ `httpGet` ç‚ºä¾‹å­ï¼Œå¦‚æœ container æ²’è¾¦æ³•æº–æ™‚å›æ‡‰ `/healthy` HTTP GET çš„è¦æ±‚æˆ–ç™¼ç”ŸéŒ¯èª¤ç­‰ç­‰ï¼Œå‰‡æœƒè¢«è¦–ç‚º Unhealthy ä¸¦ä¸”è¢«é‡å•Ÿã€‚ï¼ˆé™¤äº† `httpGet` ä»¥å¤–é‚„æœ‰å…¶ä»–æ–¹æ³•ï¼Œè«‹åƒè€ƒ [Probe](https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.19/#probe-v1-core)ï¼‰
- **readinessProbe** - [`kubelet`](/blog/k8s-intro/00#kubelet) æœƒæ ¹æ“š readinessProbe çš„å®šç¾©ä¾†æª¢æŸ¥ container æ˜¯å¦è™•æ–¼æº–å‚™å¥½çš„ç‹€æ…‹ï¼Œç•¶readinessProbe ç™¼ç”ŸéŒ¯èª¤æ™‚ container ä¸¦ä¸æœƒåƒ livenessProbe Failure ä¸€æ¨£è¢«é‡å•Ÿï¼Œä½† container æœƒè¢«ç•¶ä½œè™•æ–¼ **æœªå°±ç·’ (Unready)** çš„ç‹€æ…‹ï¼Œä¸¦ä¸”å¦‚æœæ˜¯ [Service](/blog/k8s-intro/00#service) æ‰€é¸æ“‡çš„ Pod æ™‚å‰‡æœƒè¢«å‰”é™¤æ–¼ Service çš„ LoadBalancing é¸æ“‡ä¸­ ã€‚ï¼ˆä»¥å¾Œèªªåˆ° Service æ™‚æœƒåœ¨å¤šåŠ èªªæ˜ï¼‰â€Œâ€Œèˆ‰å€‹å¸¸è¦‹ readinessProbe çš„ç”¨æ³•ï¼Œåƒæ˜¯ container éœ€è¦æ§‹é€šä¸€å€‹ databaseï¼Œä½†æ˜¯ database å»å› ç‚ºæŸäº›åŸå› è€Œç„¡æ³•æ¶è¨­é€£çµï¼Œé€™æ™‚å€™ **container é›–ç„¶æ˜¯_å¥åº·çš„ç‹€æ…‹ (Healthy)_ å»ä¹Ÿæ˜¯ _æœªå°±ç·’ç‹€æ…‹ (Unready)_**ã€‚ï¼ˆä¸‹é¢æœ‰æ›´å¤šä¿¡æ¯ï¼‰

---

## Resources & QoS

äº†è§£è‡ªå·± container æ‰€éœ€çš„è³‡æºæ˜¯éå¸¸é‡è¦çš„ä¸€ä»¶äº‹ï¼Œé™¤äº†åœ¨è‡ªé©æ‡‰æ“´ç¸®ï¼ˆautoscalingï¼‰ä¸Šæœ‰æ¥µå¤§çš„å½±éŸ¿å¤–ï¼Œ åœ¨ k8s ä¸­é‚„æœ‰éå¸¸é‡è¦çš„æ„ç¾©ï¼Œé‚£å°±æ˜¯ Pod çš„ QoS å±¬æ€§ã€‚

::note
**_ğŸ’¡ k8s èªªåˆ°åº•å°±æ˜¯å¤šå€‹ Node (æ©Ÿå™¨/ä¼ºæœå™¨) å’Œå†ä¸€èµ·å…±åŒçš„é›†åˆé«”ã€‚åœ¨æ©Ÿå™¨çš„è³‡æºä¸å¤ ç”¨çš„æ™‚å€™ï¼Œk8s æœƒæ ¹æ“š Pod çš„é‡è¦æ€§ä¾†ä¾æ¬¡å°‡ Pod å‰”é™¤ (eviction)ï¼Œç›´åˆ°ç³»çµ±æœ‰è¶³å¤ çš„è³‡æºä½¿ç”¨ã€‚â€Œâ€ŒPod çš„é‡è¦æ€§é¦–å…ˆæ˜¯çœ‹ PriorityClassï¼Œæ¥è‘—å°±æ˜¯çœ‹ QoSã€‚ï¼ˆä»¥å¾Œæœƒåœ¨æåˆ° PriorityClassï¼‰_**
::

é¦–å…ˆè¦åœ¨ç´°èªªä¸‹ç•¶ container ä½¿ç”¨è¶…é Request å’Œ Limit æ™‚æœƒç™¼ç”Ÿä»€éº¼äº‹ï¼š

- `CPU exceeds request`ï¼Œç•¶ CPU ä½¿ç”¨è¶…éè¦æ±‚çš„è³‡æºæ™‚ï¼Œç„¡è«–æ˜¯å¦æœ‰è¨­ç½® CPU limit Pod å¯ä»¥ä½¿ç”¨ç³»çµ±ä¸­å¤šé¤˜çš„ CPUã€‚
- `CPU exceeds limit`ï¼Œç•¶ CPU ä½¿ç”¨è¶…éé™åˆ¶çš„è³‡æºæ™‚ï¼Œ Pod ä¸­çš„ container æœƒè¢«å£“æŠ‘ (throttling)ã€‚
- `Memory exceeds request`ï¼Œç•¶ Memory ä½¿ç”¨è¶…éè¦æ±‚æ™‚ï¼Œâ€Œâ€Œ- å¦‚æœ Pod æœ‰è¨­ç½® Memory limitï¼ŒPod ä¸­çš„ container å¯ä»¥ä½¿ç”¨ç³»çµ±ä¸­å¤šé¤˜çš„ Â Memoryã€‚â€Œâ€Œä½†å¦‚æœ Pod æ²’æœ‰è¨­ç½® Memory limitï¼Œåœ¨ç³»çµ±éœ€è¦å…§å­˜è³‡æºæ™‚ Pod ä¸­çš„ container å¯èƒ½æœƒè¢«åˆªé™¤ (OOM Killedï¼ŒOut of Memory Kill)ã€‚
- `Memory exceeds limit`ï¼Œç•¶ Memory ä½¿ç”¨è¶…éé™åˆ¶æ™‚ Pod ä¸­çš„ container æœƒè¢«åˆªé™¤ (OOM Killedï¼ŒOut of Memory Kill)ã€‚

::note
**_ğŸ’¡ CPU - Compressible ï¼ˆå¯å£“ç¸®ï¼‰  
ğŸ’¡ Memory - Incompressible ï¼ˆä¸å¯å£“ç¸®ï¼‰_**
::

QoS (Quality of Service) ä¸­æ–‡ç›´ç¿»æœå‹™è³ªé‡ï¼Œç”¨æ–¼è¡¨ç¤º Pod çš„å¯è®Šå‹•æ€§ã€‚QoS æœ‰ä¸‰å€‹å€¼ï¼Œåˆ†åˆ¥æ˜¯ï¼š

- `Guaranteed - High Priority` (é«˜é‡è¦æ€§ï¼Œä¸å®¹æ˜“è¢«åˆªé™¤çš„ Pod)â€Œâ€Œ ç•¶æ‰€æœ‰ container ä¸­ resource çš„ request å’Œ limit ç›¸åŒæ™‚ï¼ŒPod çš„ QoS å°‡æœƒæ˜¯ Guaranteedã€‚ç°¡å–®ä¾†èªªå°±æ˜¯ä½¿ç”¨è€…ä¿è­‰è‡ªå·±çš„ Pod ä¸æœƒä½¿ç”¨è¶…é resource çš„å®šç¾©ã€‚
- `Burstable - Medium Priority` (ä¸­ç­‰é‡è¦æ€§ï¼Œæœ‰å¯èƒ½è¢«åˆªé™¤çš„ Pod) â€Œâ€Œç•¶æ¢ä»¶ä¸ç¬¦åˆ Guaranteed æ™‚ï¼Œä¸¦ä¸” Pod ä¸­æœ‰ä»»ä¸€ container æœ‰è¨­ç½® resource request æ™‚ï¼ŒPod çš„ QoS å°‡æœƒæ˜¯ Burstableã€‚
- `BestEffort - Low Priority` (ä½é‡è¦æ€§ï¼Œå®¹æ˜“è¢«åˆªé™¤çš„ Pod)â€Œâ€Œ ç•¶ Pod ä¸­æ²’æœ‰ä»»ä¸€ container æœ‰è¨­ç½® resource request æ™‚ï¼ŒPod çš„ QoS å°‡æœƒæ˜¯ Burstableã€‚

æ‰€ä»¥ QoS ç©¶ç«Ÿä»£è¡¨ä»€éº¼å‘¢ï¼Ÿç°¡å–®ä¾†èªªå¦‚æœä»Šå¤©æœ‰å…©å€‹æ­£åœ¨é‹è¡Œçš„ Podï¼Œåˆ†åˆ¥æœ‰ QoS Guaranteed å’Œ Burstableï¼Œåœ¨ç³»çµ±è³‡æºä¸å¤ ç”¨æ™‚ï¼Œk8s æœƒé¦–å…ˆå‰”é™¤ QoS ç‚º Burstable çš„ Pod ä¾†ç·©è§£ç³»çµ±çš„å£“åŠ›ã€‚

::note
**_â—ï¸ å‰µå»ºæ–°çš„ Pod æ™‚ï¼Œç•¶ k8s cluster ä¸­è³‡æºä¸å¤ ç”¨æ™‚ï¼Œå³ä¾¿æœ‰è¼ƒä½çš„ QoS Pod å­˜åœ¨ï¼Œk8s ä¹Ÿä¸æœƒå› ç‚ºæ–°è¦å‰µå»ºçš„ Pod æœ‰è¼ƒé«˜çš„ QoS è€Œå‰”é™¤è¼ƒä½ QoS çš„ Podã€‚â€Œâ€Œé€™ç¨®ç‚ºäº† High Priority è€Œå‰”é™¤ Low Priority çš„å‹æ…‹å«åš Preemptionï¼Œæ˜¯å±¬æ–¼ PriorityClass ç›¸é—œçš„å…§å®¹ï¼Œå’Œ QoS ä¸¦ç„¡é—œé€£ã€‚_**

**_QoS åªæœ‰åœ¨ç³»çµ±è³‡æºä¸è¶³æ™‚å¿…é ˆå‰”é™¤ Pod æ™‚æ‰æœƒè¢«è€ƒæ…®é€²å»ï¼Œå¦‚æœä½ ä½¿ç”¨çš„ cluster æœ‰é«˜æ‰‹åœ¨å¾Œé¢ç´°å¿ƒé—œç…§ï¼Œä¸¦ä¸”æœ‰è¨­ç½® kubelet reservation åŠ system reservationï¼Œå‰‡é€™ç¨®äº‹æƒ…å°‡æœƒå¾ˆå°‘ç™¼ç”Ÿã€‚_**
::

---

## Probe

å› ç‚º **livenessProbe** åŠ **readinessProbe** æ˜¯éå¸¸é‡è¦çš„æ¦‚å¿µï¼Œæ‰€ä»¥é€™è£¡ç´°èªªä¸€ä¸‹ä¾‹å­ä¸­çš„å¹¾å€‹è¨­å®š initialDelaySecondsã€periodSecondsã€failureThresholdï¼š

- initialDelaySeconds æ˜¯åˆå§‹å»¶é²æ™‚é–“ï¼Œåœ¨ container å•Ÿå‹•ä¹‹å¾Œå¯èƒ½éœ€è¦æ•¸ç§’ç”šè‡³å¹¾åˆ†é˜ä¾†ç¶­æŒç‹€æ…‹ã€‚ä¸€èˆ¬ä¾†èªª readinessProbe çš„ initialDelaySeconds æœƒæ¯” livenessProbe è¦é•·ä¸€äº›ã€‚ï¼ˆå…ˆç¢ºä¿è™•æ–¼å¥åº·çš„å¯åŸ·è¡Œç‹€æ…‹ï¼Œåœ¨ç¢ºå®šæ˜¯å¦å°±ç·’ï¼‰
- periodSeconds æ˜¯æ¯æ¬¡ç¢ºèªçš„é–“éš”ç§’æ•¸
- failureThreshold æ˜¯æŒ‡å¤±æ•—å¤šå°‘æ¬¡æ‰å°‡å…¶æ­¸é¡æ–¼ä¸å¥åº·æˆ–æœªå°±ç·’ç‹€æ…‹ã€‚ç›¸åçš„ï¼Œä¹Ÿæœ‰ successThreshold çš„è¨­å®šã€‚
- å…¶ä»–è¨­å®šé‚„æœ‰ timeoutSecondsï¼Œé€™è£¡å› ç‚ºéå¸¸é¡§åæ€ç¾©æ‰€ä»¥å°±ä¸å¤šåšèªªæ˜ã€‚

```yaml
initialDelaySeconds: 5
periodSeconds: 10
failureThreshold: 2
```

ä»¥ä¸Šé¢çš„è¨­å®šä¾†èªªå°±æ˜¯ï¼Œcontainer å‰µå»ºå¥½ 5 ç§’å¾Œé–‹å§‹ liveness/readiness Probeï¼Œæ¯ 10 ç§’ä¸€æ¬¡ï¼Œä¸èƒ½é€£çºŒå¤±æ•—å…©æ¬¡ã€‚

---

## ç¸½çµ

é™¤äº†ä¸Šé¢çš„è¨­å®šä»¥å¤–ï¼ŒPod é‚„æœ‰è¨±å¤šå…¶ä»–çš„è¨­å®šï¼Œé€™è£¡åªä»‹ç´¹äº†å¹¾å€‹å‰µå»º Pod æ™‚å¿…é ˆè¦çŸ¥é“çš„è¨­å®šï¼Œç‰¹åˆ¥æ˜¯ livenessProbe/readinessProbe ä»¥åŠ resourceã€‚â€Œâ€Œä¸€èˆ¬ä¾†èªªä½¿ç”¨è€…ä¸æœƒè‡ªå·±å‰µå»º Podï¼Œè€Œæ˜¯æœƒåœ¨å…¶å®ƒ `k8s` å·¥ä½œé™„è¼‰è³‡æº (Workload Resource) ä¸­é€éå®šç¾© PodTemplate ä¾†å‰µå»º Podã€‚æ¥ä¸‹ä¾†å¹¾å€‹ç« ç¯€æœƒæ…¢æ…¢ä»‹ç´¹å¹¾å€‹å¸¸è¦‹çš„ Workloadsã€‚

---
